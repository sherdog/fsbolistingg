<% content_for :head do %>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
<script type="text/javascript"> 
  
    var markers_array = [];
  var map = null;  
  var infowindow = new google.maps.InfoWindow();
  function initialize() {
    var iconBase = 'http://cvsimotorsports.com/';
    // Create the map 


    // No need to specify zoom and center as we fit the map further down.
    var map = new google.maps.Map(document.getElementById("map_canvas"), {
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      streetViewControl: false
    });


    
// Define the list of markers.
    // This could be generated server-side with a script creating the array.
    var markers = [
      <% @listings.each_with_index do |listing, index| %>
      { lat: <%= listing.latitude %>, lng: <%= listing.longitude %>, name: " ", html: '<div style="width:300px;"><img src="<%= listing.images.first.image.url(:small) %>"  style="margin:20px 5px 5px 5px" height="75" align="right" /><%= listing.address_1 %> <br /> <% if listing.address_2.present? %><%= listing.address_2 %><br /><% end %><%= listing.city %>, <%= listing.state %> <%= listing.zipcode %><br /><%= number_to_currency(listing.price) %><br /><strong>P.</strong> <%= listing.contact_number %> <br /><%= link_to 'View Listing',  view_listing_path(listing) %></div>' } <%= "," unless listing == @listings.last %>
       <% end %>
    ];
    

    // Create the markers ad infowindows.
    for (index in markers) {
      addMarker(markers[index]);
      markers_array.push(markers[index]);
    } 

    function addMarker(data) {
      
      // Create the marker
      var iconShadow = {
        url: iconBase + 'icon_shadow.png',
        anchor: new google.maps.Point(3,13)
      };


      var marker = new google.maps.Marker({
        icon: iconBase + 'fsbo_marker.png',
        shadow: iconShadow,
        position: new google.maps.LatLng(data.lat, data.lng),
        map: map,
        title: data.name
      });

      markers_array.push(marker);
      // Create the infowindow with two DIV placeholders
      // One for a text string, the other for the StreetView panorama.
      var content = document.createElement("DIV");
      var title = document.createElement("DIV");
      var html = document.createElement("DIV");
      var streetview = document.createElement("DIV");
      html.innerHTML = data.html;
      title.innerHTML = data.name;
      content.appendChild(title);
      content.appendChild(html);
      
      streetview.style.width = "500px";
      streetview.style.height = "300px";
      //content.appendChild(streetview);

      infowindow = new google.maps.InfoWindow({
        content: content,
        size: new google.maps.Size(400,100)
      });



      // Open the infowindow on marker click
      google.maps.event.addListener(marker, "click", function() {
       
        infowindow.open(map, this);
      });
    
      // Handle the DOM ready event to create the StreetView panorama
      // as it can only be created once the DIV inside the infowindow is loaded in the DOM.
      google.maps.event.addListenerOnce(infowindow, "domready", function() {
        var panorama = new google.maps.StreetViewPanorama(streetview, {
            navigationControl: false,
            enableCloseButton: false,
            addressControl: false,
            linksControl: false,
            visible: true,
            position: marker.getPosition()
        });
      });
    }

    // Zoom and center the map to fit the markers
    // This logic could be conbined with the marker creation.
    // Just keeping it separate for code clarity.
    var bounds = new google.maps.LatLngBounds();
    for (index in markers) {
      var data = markers[index];
      bounds.extend(new google.maps.LatLng(data.lat, data.lng));
    }
    map.fitBounds(bounds);
  }

    
  $(document).ready(function(){
      $('#toggle_search_box').click(function(e){
          e.preventDefault();
          $('#search_box').slideToggle();
      });

      $('#btn_close_search_box').click(function(e){
        e.preventDefault();
        $('#search_box').slideToggle();
      });

      $('.marker_toggle').mouseover(function(e){
        var id = $(this).attr('id');
        id = id.replace('listing_', '');
        infowindow.open(null,null);
        google.maps.event.trigger(markers_array[id], 'click');
      });
  });
</script> 
<% end %>


<div class="row" style="height:100%; margin-right:0px;">
  <div id="sidebar_listings" class="col-4" style="padding-top:70px; ">
    <% @listings.each_with_index do |listing, index| %>
     
      <% if listing.featured? %>
        <div class="row"><div class="col-12"><span class="label label-danger">featured</span></div></div>
      <% end %>

      <div class="row" id="row_<%= index %>" >
        
        <div class="col-4" >
          <%= image_tag(listing.images.first.image.url(:medium), :class => 'img-responsive img-thumbnail') %>
        </div>

        <div class="col-8">
          <div class="row">
            <div class="col-12">
             <%= link_to "#{listing.address_1} #{listing.address_2}, #{listing.city}, #{listing.state} #{listing.zipcode}", view_listing_path(listing), :class => 'marker_toggle', :id => 'listing_' + index.to_s %>
            </div>
          </div>
          
          <div class="row">
            <div class="col-12">
              <strong>Price: </strong><%= number_to_currency(listing.price) %>
            </div>
          </div>
          
          <div class="row" style="margin-top:10px;">
            <div class="col-12">
                <table class="table table-condensed">
                  <tr>
                    <td>Beds: <%= listing.bedrooms %></td>
                    <td><%= listing.property_type %></td>
                  </tr>
                  <tr>
                    <td>Baths: <%= listing.bathrooms %></td>
                    <td><%= listing.sqft %> Sq. Ft.</td>
                  </tr>
                  <tr>
                    <td>Lot size: <%= listing.lot_size %></td>
                    <td>Built: <%= listing.year_built %></td>
                  </tr>
                </table>
            </div>
          </div>
        
      </div>
      <hr />
        </div>

     
    <% end %>
  </div>
    <div class="col-8" style="height:100%; padding-left:0px; padding-right:0px; position:relative;">
    <div class="search_bar ">
      <%= form_tag listings_path, :method => :get, :class => 'form-inline' do %>

              <div class="row" style="margin-right:0px;">
                <div class="col-6">
                  <div class="input-group">
                    <%= text_field_tag :q, params[:q], :placeholder => 'Address or City or Zipcode', :class => 'form-control' %>
                    <span class="input-group-btn"><%= button_tag "Search", :class => 'btn btn-default' %></span>
                  </div>
                </div>
                <div class="col-4">
                     <a href="#" id="toggle_search_box" >Advanced Search</a>
                </div>
              </div>
              <% end %>

          
        
        <div id="search_box" style="display:none;" class="shadow">
         <a href="#" id="btn_close_search_box" class="close">&times;</a>
         <div class="search_box_inner ">
          <h3>Advanced Search</h3>
          <%= form_tag listings_path, :method => :get, :class => 'form-horizontal' do  %>
          <input type="hidden" name="search" value="true" />
            <div class="row">
            </div>
            <div class="row">
              <div class="col-12">
                <label>Price</label>
              </div>
            </div>
            <div class="row">
              <div class="col-5 input-group" >
                  <span class="input-group-addon input-sm">$</span>
                  <%= text_field_tag :price_from, params[:price_from], :placeholder => "Min", :class => 'form-control input-sm' %></div>
                  <div class="col-2 text-center">-</div>
                  <div class="col-5 input-group"><span class="input-group-addon input-sm">$</span><%= text_field_tag :price_to, params[:price_to], :placeholder => "Max", :class => 'form-control input-sm' %>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <label>Bedrooms</label>
              </div>
              <div class="col-6">
                <label>Bathrooms</label>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <select name="bedrooms" id="bedrooms" class="form-control input-sm">
                  <option value="1" <% if params[:bedrooms] == 1 %> selected="selected" <% end %>>1+</option>
                  <option value="2" <% if params[:bedrooms] == 2 %> selected="selected" <% end %>>2+</option>
                  <option value="3" <% if params[:bedrooms] == 3 %> selected="selected" <% end %>>3+</option>
                  <option value="4" <% if params[:bedrooms] == 4 %> selected="selected" <% end %>>4+</option>
                  <option value="5" <% if params[:bedrooms] == 5 %> selected="selected" <% end %>>5+</option>
                  <option value="6" <% if params[:bedrooms] == 6 %> selected="selected" <% end %>>6+</option>
                  <option value="7" <% if params[:bedrooms] == 7 %> selected="selected" <% end %>>7+</option>
                  <option value="8" <% if params[:bedrooms] == 8 %> selected="selected" <% end %>>8+</option>
                  <option value="9" <% if params[:bedrooms] == 9 %> selected="selected" <% end %>>9+</option>
                </select>
              </div>
              <div class="col-6">
                <select name="bathrooms" id="bathrooms" class="form-control input-sm">
                  <option value="1" <% if params[:bathrooms] == 1 %> selected="selected" <% end %> >1+</option>
                  <option value="2" <% if params[:bathrooms] == 2 %> selected="selected" <% end %>>2+</option>
                  <option value="3" <% if params[:bathrooms] == 3 %> selected="selected" <% end %>>3+</option>
                  <option value="4" <% if params[:bathrooms] == 4 %> selected="selected" <% end %>>4+</option>
                  <option value="5" <% if params[:bathrooms] == 5 %> selected="selected" <% end %>>5+</option>
                  <option value="6" <% if params[:bathrooms] == 6 %> selected="selected" <% end %>>6+</option>
                  <option value="7" <% if params[:bathrooms] == 7 %> selected="selected" <% end %>>7+</option>
                  <option value="8" <% if params[:bathrooms] == 8 %> selected="selected" <% end %>>8+</option>
                  <option value="9" <% if params[:bathrooms] == 9 %> selected="selected" <% end %>>9+</option>
                </select>
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <label>City</label>
              </div>  
            </div>

            <div class="row">
              <div class="col-12">
                <%= select_tag :city, options_from_collection_for_select(@cities, "city", "city"), :class => 'form-control input-sm', :prompt => 'Any' %>
              </div>
            </div>
            <hr />
            <div class="row">
              <div class="col-12">
                  <%= submit_tag "Search", :class => 'btn btn-primary' %>
              </div>
            </div>



         <% end %> 

         </div>
        </div>


    </div>
    <div id="map_canvas" ></div> 
  </div>

</div>
